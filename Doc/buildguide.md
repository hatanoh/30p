# ビルドガイド

## 略語
以下のようにキーボード名を省略します
|名称                |略称|
|--------------------|----|
|Bootleg31           |BL31|
|Soroban30(Bootleg30)|BL30|
|Ally13              |AL13|
|Ally24              |AL24|

## 必要な部品
今回は基板とトップ/ボトムプレートのみの提供であるため
以下のものが必要です。
さらに単4乾電池1本が必要です。ニッケル水素充電池でも問題ありません(0.7Vまでシャットダウンしないので過放電には気を付けてください)。

|品名|BL31|BL30|AL13|AL24|
|----|----|----|----|----|
|BLE microPro(Boothのぎけす屋,遊舎工房)          | 1| 1| 1| 1|
|コンスルー(2.54mm/12pin,遊舎工房)               | 2| 2| 2| 2|
|M2 4mm  超低頭ネジ(日東精工 ラミクス, Wilcoなど)|22|22|24|24|
|M2 両メススペーサ 7mm(8.5mm)                    | 0|11|12|12|
|M2 両メススペーサ 11mm                          |11| 0| 0| 0|
|ゴム足 8mm                                      | 6| 6| 6| 6|
|電源部品(別表参照)                              |一式|一式|一式|一式|
|コンスルー(別表参照)                            |不要|一式|一式|一式|
|スライドスイッチ横型(SK-12D01-VG4, 秋月P-08789) | 1| 1| 1| 1|
|タクトスイッチ(TVBP06, 秋月P-08073, 遊舎工房)   | 1| 1| 1| 1|
|単4電池ケース(ピン型, 秋月P-02670)              | 1| 1| 1| 1|
|レバースイッチ(TMHU26/27,秋月P-08070,P-08071)   | 2| 2| 2| 2|
|SMDダイオード(1D4148W,秋月I-07084,遊舎工房)     |37|39|40|41|
|2u PCB取り付けスタビライザ(遊舎工房など)        | 1| 1| 0| 0|
|kailhMXソケット(遊舎工房など)                   |31|33|34|35|
|MXスイッチ(各種ショップ)                        |31|33|34|35|
|キーキャップ 1u                                 |28|28|30|29|
|キーキャップ 1.25u                              | 0| 2| 2| 2|
|キーキャップ 1.5u                               | 1| 0| 0| 2|
|キーキャップ 1.75u                              | 1| 1| 2| 2|
|キーキャップ 2u                                 | 0| 1| 0| 0|
|キーキャップ ISOEnter                           | 1| 0| 0| 0|

BL30及びAL24はキースイッチとネジ頭が重なる箇所があります(各1箇所/購入時に確認して下さい)ので、少なくともそこ箇所はラミクスを使用する必要があります。
レバースイッチはオプションです。必ずしも必要はないでしょう(BL31以外では未検証です)
レバースイッチを実装しない場合はダイオードは-6個してください。
BL31以外でレバースイッチを実装する場合は7mmのスペーサを8.5mmに変更する必要があります(未検証)8mmでも良いかもしれません。
レバースイッチはTMHU26あるいは27の好きな方を使ってください。TMHU28は接点数が異なるため使用できません。

電源部品だけは入手が面倒なのでセットを別に用意しています。コンデンサも付けてありますが小さいのでなくした場合には秋月などで0603 10uFの積層セラミックコンデンサを購入してください。
|品名|数量|
|----|----|
|DCDCコンバータ(TI TPS61221DCK)                  |1|
|インダクタ 4.7uH 3030(Murata LQH3NPZ4R7MMEL)    |1|
|コンデンサ 10uF 0603(Murata GRM188R60J106KE47D) |2|

トッププレートとキーボード基板を結ぶコンスルーも入手に難があるので別に用意しています
|品名|数量|
|----|----|
|コンスルー(1.27mm 16pin H3.5mm)                 |1|

キースイッチやキーキャップはお好みのものを使用してください。
XDAやDSAのような段による形状の違いがないキーキャップの方が合わせやすいかもしれません。
特にSoroban30(Bootleg30)は40%キーボード向けのキーキャップセットを使うと良いかもしれません。

## トッププレート
BMPと電源回路とリセットスイッチはトッププレートに載っています。
1. 裏面にTPS61221とインダクタ(4.7uH)とコンデンサ(10uF)2個を実装します。
2. 裏側から、スライドスイッチ、リセットスイッチを実装します。
3. 表から、電池ケースを実装します。
4. 電池を入れ、スイッチをONにし、BATとGNDの間が3.3Vであることを確認する。
(cscsシリーズと異なり秋月DCDC昇圧基板を使用するようなワークアラウンドはありません)

テスタで電源が期待通りの電圧を出力をしてることを確認するまでは*絶対にBLE Micro Proを接続してはいけません*。

電源部分の組み立ては(cscsシリーズのビルドガイド)[https://github.com/hatanoh/cscs_family/blob/master/Doc/buildguide.md]も参考になると思います。

## キーボード基板
1. ダイオードを半田付けします。レバースイッチを実装しない場合は横向きのダイオードは半田付けする必要はありません。が、不安だったら全部付けても大丈夫です。
向きはシルクの通りで縦横それぞれですべて同じです。
2. ソケットを半田付けします。
3. 必要に応じて、レバースイッチを半田付けしてください。浮かないように気をつけて取り付けてください。

## 基板の組み立て
1. トッププレートにスペーサーをネジ止めしていきます。ものによってはネジ頭がキースイッチホールにはみ出たりするかもしれませんし、キースイッチに重なったりします。
その場合削ったり取り付けを諦めたりしてください。ラミクスを使っていれば、多少キースイッチにかぶっていても問題はないんじゃないかと思います。
2. トッププレートにスイッチをはめ込みます。スイッチによってはきついことがありますので、削ったり諦めたりしてください(今回のBL30の穴はやや小さめでした)
3. スイッチの端子が曲がっていないことを注意深く確認してください。
4．トッププレートの電源回路側の1.25mmスルーホールに1.27mmコンスルーを差し込み、キースイッチをソケットにさすのと一緒にキーボード基板にそっと押し込んでいきます。
5. BMPをコンスルーでトッププレート裏に取り付けます。
6. ボトムプレートを取り付け、ネジ止めしていきます。こちらはねじ頭がゴム足より低ければ必ずしもラミクスを使う必要がありません。
7. ゴム足を貼ります。貼る場所が丸く指定されていますのでそこに貼ると良いでしょう(BL31以外)

## ファームウェア
ビルド環境の整備は[BLE Micro Pro](https://github.com/sekigon-gonnoc/BLE-Micro-Pro) のページを参照してください。
他関連情報は[サリチル酸さんのガイド](https://salicylic-acid3.hatenablog.com/entry/BMP-Introduction)やそこからたどるページを参照されると良いかと思います。

1. ソースを取得します
```
% git clone -b nrf52 https://github.com/hatanoh/qmk_firmware.git 
```
2. ビルドします
BL31
```
% make sarasarado30_ble/b31ij:default:nrfutil
```
BL30
```
% make sarasarado30_ble/bl30aj:default:nrfutil
```
AL13
```
% make sarasarado30_ble/ally13:default:nrfutil
```
AL24
```
% make sarasarado30_ble/ally24:default:nrfutil
```
3. ビルドが終わって接続待ちのテケテケが出始めたら、リセットボタンを押しながらusbケーブルを繋ぐ

## 動作確認
1. BMPにファームを書き込みます。
2. キーの動作を確認します。動かないキーがあった場合、キースイッチの端子が折れていたり、ダイオードの半田付けが甘かったり、極性が反対だったりしないか確認します。
